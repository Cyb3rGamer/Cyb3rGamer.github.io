<html>

<head>
  <title>Free Delisted Checker</title>
  <link rel="stylesheet" href="shared.css">
</head>

<body>
  <div class="container">
    <header>
      <h1>Free Delisted Checker</h1>
      <button id="themeToggle">ðŸŒ™ Toggle Dark Mode</button>
    </header>
    <p>[1] Enter your appids below, one per line (<a href="https://cyb3rgamer.github.io/how_to_get_your_appids.html">how
        to get them?</a>):</p>
    <textarea id="appids" rows="4" cols="50"></textarea>
    <br />
    <button id="checkAppids">[2] Check how many delisted games you own</button>
    <br />
    <div id="result"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;

    // Initialize theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      html.setAttribute('data-theme', savedTheme);
      themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    });

    async function fetchWithProxy(apiUrl) {
      // REPLACE THIS WITH YOUR CLOUDFLARE WORKER URL
      const WORKER_URL = "YOUR_CLOUDFLARE_WORKER_URL";

      const proxies = [
        url => WORKER_URL ? `${WORKER_URL.endsWith('/') ? WORKER_URL : WORKER_URL + '/'}?url=${encodeURIComponent(url)}` : null,
        url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
        url => `https://corsproxy.io/?${encodeURIComponent(url)}`
      ].filter(p => p !== null);

      for (const getProxyUrl of proxies) {
        const proxyUrl = getProxyUrl(apiUrl);
        if (!proxyUrl || proxyUrl.startsWith("YOUR_CLOUDFLARE")) continue;

        try {
          const response = await fetch(proxyUrl);
          if (!response.ok) continue;

          let data = await response.json();
          // Handle AllOrigins wrapper if necessary
          if (data.contents) {
            data = JSON.parse(data.contents);
          }
          return data;
        } catch (e) {
          console.warn(`Proxy ${proxyUrl} failed, trying next...`, e);
        }
      }
      throw new Error("All CORS proxies failed. Please ensure your Cloudflare Worker is deployed and its URL is correctly set.");
    }

    $("#checkAppids")
      .on
      ("click"
        , async function () {
          $(this).prop("disabled", true);
          $(this).text("Checking...");
          try {
            const appids =
              $("#appids").val().split("\n").map(function (line) {
                return line.trim();
              }).filter(function (line) {
                return line.length > 0;
              });

            if (appids.length === 0) {
              alert("Please enter at least one appid.");
              $(this).prop("disabled", false);
              $(this).text("Check Appids");
              return;
            }

            const data = await fetchWithProxy("https://steam-tracker.com/api?action=GetAppList");
            const grouped =
              data.removed_apps.reduce
                ((acc, item) => {
                  const key = item.category;
                  if (!acc[key]) { acc[key] = []; }
                  acc[key].push(item);
                  return acc;
                }
                  , {}
                );

            $("#result").empty().append
              ($("<table>").append
                (Object.keys(grouped)
                  .map
                  (key => {
                    const total = grouped[key].length;
                    const owned = grouped[key].filter(item => appids.includes(item.appid.toString())).length;
                    const percentage = ((owned / total) * 100).toFixed(0);
                    return `<tr><td><h3>${key}</h3></td><td>${percentage}%</td><td>${owned} / ${total}</td></tr>`;
                  }
                  )
                )
              );

            $(this).prop("disabled", false);
            $(this).text("Check Appids");
          }
          catch (e) {
            $(this).prop("disabled", false);
            $(this).text("Check Appids");
            console.error(e);
            alert(e.message || "An error occurred while checking appids. Please try again.");
          }
        }
      );
  </script>
</body>

</html>